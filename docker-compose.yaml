services:
  # Step 1: Generate config file
  valhalla_config:
    image: ghcr.io/valhalla/valhalla:latest
    container_name: valhalla_config
    volumes:
      - ./valhalla_data:/data
    command: >
      sh -c "valhalla_build_config > /data/valhalla.json"
    # Run once: docker compose run valhalla_config

  # Step 2: Build tiles from OSM extract
  valhalla_tiles:
    image: ghcr.io/valhalla/valhalla:latest
    container_name: valhalla_tiles
    volumes:
      - ./valhalla_data:/data
    command: >
      valhalla_build_tiles -c /data/valhalla.json /data/philippines.osm.pbf
    # Run once: docker compose run valhalla_tiles

  # Step 3: Start Valhalla service
  valhalla:
    image: ghcr.io/valhalla/valhalla:latest
    container_name: valhalla
    ports:
      - "8002:8002"
    volumes:
      - ./valhalla_data:/data
    command: >
      valhalla_service /data/valhalla.json 1
    # Run: docker compose up valhalla
